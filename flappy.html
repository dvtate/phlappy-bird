<!DOCTYPE html>
<html>
    <head>
        <title>Postfix-Haskell WASM Demo</title>
        <style>
            html, body {
                height: 100%;
                margin: 0;
            }

            body {
                background: black;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            canvas {
                border: 1px solid white;
            }
        </style>
    </head>
    <body>
        <canvas width="768" height="1024" id="game"></canvas>

        <script>
            (async () => {
                // Get canvas 2d context
                const canvas = document.getElementById('game');
                const context = canvas.getContext('2d');

                const thwomp = document.createElement('img');
                thwomp.src = 'thwomp.png';

                // Instantiate wasm
                const resp = await fetch('game.wasm');
                const wasm = await resp.arrayBuffer();
                const mod = await WebAssembly.instantiate(wasm, {
                    js: {
                        'console.log': console.log,
                        'Math.random': () => {
                            const ret = Math.random();
                            console.log('rand', ret);
                            return ret
                        },

                        setFill(r, g, b) {
                            context.fillStyle = `rgb(${r}, ${g}, ${b})`;
                        },

                        contextFillRect: (...args) => {
                            // console.log('cfrect', args);
                            context.fillRect.bind(context)(...args);
                        },
                        contextClearRect: context.clearRect.bind(context),

                        nextFrame() {
                            requestAnimationFrame(mod.instance.exports.loop);
                        },

                        drawThwomp(x, y, w, h) {
                            // console.log('thwomp', thwomp, x, y, w, h);
                            context.drawImage(thwomp, x, y, w, h);
                        }
                    },
                });

                // Debugging
                window.mod = mod;
                window.context = context;
                window.thwomp = thwomp;
                window.showMem = () => {
                    console.log('i32', [...new Int32Array(mod.instance.exports.memory.buffer)].slice(0,15));
                    console.log('f32', [...new Float32Array(mod.instance.exports.memory.buffer)].slice(0,15));
                };

                // Get exports
                const { loop, flap, space_up, init }
                    = mod.instance.exports;

                // Listen to keyboard events to move the paddle
                document.addEventListener('keydown', function(e) {
                    if (e.which === 32) {
                        flap();
                        console.log('space');
                    }
                });

                // Listen to keyboard events to stop the paddle if key is released
                document.addEventListener('keyup', function(e) {
                    if (e.which === 32) {
                        space_up();
                        console.log('keyup', e.which);
                    }
                });

                // Start game loop
                // loop();
                // mod.instance.exports.draw();
            })();

        </script>
    </body>
</html>